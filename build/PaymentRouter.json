{
  "contractName": "PaymentRouter",
  "constructorInputs": [
    {
      "name": "owner",
      "type": "pubkey"
    },
    {
      "name": "expectedAmountSats",
      "type": "int"
    },
    {
      "name": "minerFeeSats",
      "type": "int"
    },
    {
      "name": "invoiceIdHash",
      "type": "bytes"
    }
  ],
  "abi": [
    {
      "name": "finalize",
      "inputs": [
        {
          "name": "ownerSig",
          "type": "sig"
        },
        {
          "name": "destination",
          "type": "pubkey"
        }
      ]
    },
    {
      "name": "receiveFunds",
      "inputs": []
    }
  ],
  "bytecode": "OP_4 OP_PICK OP_0 OP_NUMEQUAL OP_IF OP_5 OP_ROLL OP_SWAP OP_CHECKSIGVERIFY OP_INPUTINDEX OP_UTXOVALUE OP_2DUP OP_SWAP OP_4 OP_PICK OP_ADD OP_GREATERTHANOREQUAL OP_VERIFY OP_ROT OP_SUB OP_TXOUTPUTCOUNT OP_1 OP_GREATERTHANOREQUAL OP_VERIFY OP_0 OP_OUTPUTVALUE OP_2 OP_PICK OP_NUMEQUALVERIFY OP_2DUP OP_NUMEQUAL OP_IF OP_TXOUTPUTCOUNT OP_1 OP_NUMEQUALVERIFY OP_ELSE OP_TXOUTPUTCOUNT OP_2 OP_NUMEQUALVERIFY OP_1 OP_OUTPUTBYTECODE OP_ACTIVEBYTECODE OP_EQUALVERIFY OP_1 OP_OUTPUTVALUE OP_OVER OP_3 OP_PICK OP_SUB OP_NUMEQUALVERIFY OP_ENDIF OP_4 OP_PICK OP_5 OP_ROLL OP_EQUALVERIFY OP_2DROP OP_2DROP OP_1 OP_ELSE OP_4 OP_ROLL OP_1 OP_NUMEQUALVERIFY OP_1 OP_VERIFY OP_3 OP_PICK OP_4 OP_ROLL OP_EQUAL OP_NIP OP_NIP OP_NIP OP_ENDIF",
  "source": "pragma cashscript ^0.12.0;\n\n/*\n  PaymentRouter.cash\n  - Purpose: Accept a buyer payment to the router and enforce invoice amount; route to merchant or vault.\n  - Constructor:\n      pubkey owner,            // platform / merchant owner (optional admin)\n      int expectedAmountSats,  // invoice amount expected for this router instance\n      int minerFeeSats,        // expected miner fee for routing tx\n      bytes32 invoiceIdHash    // hash of invoice id/metadata (optional, for indexers)\n  - Function:\n      finalize(sig ownerSig, pubkey destination)  -- called by backend to route funds after verifying payment\n  - Behavior:\n      - This contract is meant to be funded by buyer paying `expectedAmountSats`.\n      - On finalize: require inputVal >= expectedAmountSats + minerFeeSats\n        then enforce outputs sum equals inputVal - minerFeeSats and output[0] == expectedAmountSats to destination.\n      - This lets buyer pay to router and backend safely route funds.\n  Notes:\n    - Active input must be router UTXO.\n    - invoiceIdHash allows indexers to correlate payments to invoices (backend places same hash into metadata or OP_RETURN).\n*/\n\ncontract PaymentRouter(pubkey owner, int expectedAmountSats, int minerFeeSats, bytes invoiceIdHash) {\n\n  function finalize(sig ownerSig, pubkey destination) {\n    require(checkSig(ownerSig, owner));\n\n    int inputVal = tx.inputs[this.activeInputIndex].value;\n\n    // require the buyer paid at least the expected amount\n    require(inputVal >= expectedAmountSats + minerFeeSats);\n\n    int distributable = inputVal - minerFeeSats;\n\n    // backend must build outputs so that output[0] is destination with expectedAmountSats\n    require(tx.outputs.length >= 1);\n    require(tx.outputs[0].value == expectedAmountSats);\n\n    // ensure the sum of outputs equals distributable\n    // Support either single output equal to distributable or destination + change back to router\n    if (distributable == expectedAmountSats) {\n      require(tx.outputs.length == 1);\n    } else {\n      require(tx.outputs.length == 2);\n      require(tx.outputs[1].lockingBytecode == this.activeBytecode);\n      require(tx.outputs[1].value == distributable - expectedAmountSats);\n    }\n    // reference destination to avoid unused-variable warning\n    require(destination == destination);\n  }\n\n  function receiveFunds() {\n    // Accept buyer deposit to invoice router\n    require(true);\n    // reference invoiceIdHash to avoid unused-variable warning\n    require(invoiceIdHash == invoiceIdHash);\n  }\n}\n",
  "debug": {
    "bytecode": "5479009c63557a7cadc0c66e7c547993a2697b94c451a26900cc52799d6e9c63c4519d67c4529d51cdc18851cc785379949d685479557a886d6d5167547a519d51695379547a8777777768",
    "sourceMap": "25:2:50:3;;;;;26:21:26:29;;:31::36;:4::39:1;28:29:28:50:0;:19::57:1;31:12:31:42:0;;:45::57;;:24:::1;:12;:4::59;33:35:33:47:0;:24:::1;36:12:36:29:0;:33::34;:12:::1;:4::36;37:23:37:24:0;:12::31:1;:35::53:0;;:4::55:1;41:8:41:43:0;::::1;:45:43:5:0;42:14:42:31;:35::36;:6::38:1;43:11:47:5:0;44:14:44:31;:35::36;:6::38:1;45:25:45:26:0;:14::43:1;:47::66:0;:6::68:1;46:25:46:26:0;:14::33:1;:37::50:0;:53::71;;:37:::1;:6::73;43:11:47:5;49:12:49:23:0;;:27::38;;:4::40:1;25:2:50:3;;;;52::57::0;;;;54:12:54:16;:4::18:1;56:12:56:25:0;;:29::42;;:4::44:1;52:2:57:3;;;23:0:58:1",
    "logs": [],
    "requires": [
      {
        "ip": 12,
        "line": 26
      },
      {
        "ip": 21,
        "line": 31
      },
      {
        "ip": 27,
        "line": 36
      },
      {
        "ip": 32,
        "line": 37
      },
      {
        "ip": 38,
        "line": 42
      },
      {
        "ip": 42,
        "line": 44
      },
      {
        "ip": 46,
        "line": 45
      },
      {
        "ip": 53,
        "line": 46
      },
      {
        "ip": 59,
        "line": 49
      },
      {
        "ip": 69,
        "line": 54
      },
      {
        "ip": 75,
        "line": 56
      }
    ]
  },
  "compiler": {
    "name": "cashc",
    "version": "0.12.0"
  },
  "updatedAt": "2025-11-22T11:03:31.905Z"
}